#!/usr/bin/env python3

import random
from pathlib import Path
from datetime import datetime

FILES = {}

FILES['acl.auth.php'] = """\
# acl.auth.php
# <?php exit()?>
# Don't modify the lines above
#
# Access Control Lists
#
# Auto-generated by liquid initialization script
# Date: {timestamp}
*               @ALL          0
*               @user         8
"""

FILES['local.php'] = """\
<?php
/**
 * Dokuwiki's Main Configuration File - Local Settings
 * Auto-generated by liquid initialization script
 * Date: {timestamp}
 */
$conf['title'] = '{title}';
$conf['lang'] = 'en';
$conf['license'] = '0';
$conf['useacl'] = 1;
$conf['superuser'] = '@admin';
$conf['disableactions'] = 'register';
"""

FILES['plugins.local.php'] = """\
<?php
/*
 * Local plugin enable/disable settings
 *
 * Auto-generated by liquid initialization script
 * Date: {timestamp}
 */

$plugins['authad']    = 0;
$plugins['authldap']  = 0;
$plugins['authmysql'] = 0;
$plugins['authpgsql'] = 0;
"""

FILES['users.auth.php'] = """\
# users.auth.php
# <?php exit()?>
# Don't modify the lines above
#
# Userfile
#
# Format:
#
# login:passwordhash:Real Name:email:groups,comma,seperated

"""

def get_timestamp():
    return '{} UTC'.format(datetime.utcnow())

def write(target, content):
    with target.open('w', encoding='utf8') as f:
        f.write(content)

def render(target, **extra):
    options = {'timestamp': get_timestamp()}
    options.update(extra)
    content = FILES[target.name].format(**options)
    if target.exists():
        print("skipping, already exists:", target)
    else:
        print("writing:", target)
        write(target, content)


def random_salt():
    urandom = random.SystemRandom()
    return ''.join(urandom.choice('0123456789abcdef') for _ in range(128))

print("\n\n=== INITIALIZE DOKUWIKI ===\n")

data = Path('/opt/dokuwiki')

render(data / 'conf/acl.auth.php')
render(data / 'conf/local.php', title="wiki")
render(data / 'conf/plugins.local.php')
render(data / 'conf/users.auth.php')
write(data / 'data/meta/_htcookiesalt2', random_salt())
