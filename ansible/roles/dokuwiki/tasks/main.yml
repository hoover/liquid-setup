---
- name: Install php and dependencies
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - php-fpm
    - php-xml
  tags:
    - prerequisites

- name: Create /opt/dokuwiki directory
  file:
    path: /opt/dokuwiki
    state: directory
  tags:
    - prerequisites

- name: Add user liquid to group www-data
  user:
    name: liquid
    groups: www-data
    append: yes
  tags:
    - prerequisites

- name: Download DokuWiki stable source code
  shell: "wget https://download.dokuwiki.org/src/dokuwiki/dokuwiki-stable.tgz -O - | tar -xzvf - -C /opt/dokuwiki --strip 1"
  tags:
    - prerequisites

- name: Set up file permissions
  file:
    path: /opt/dokuwiki
    state: directory
    owner: www-data
    group: www-data
    recurse: true
  tags:
    - prerequisites

- name: Create nginx config
  template:
    src: nginx/dokuwiki.conf
    dest: /etc/nginx/sites-enabled/dokuwiki.conf
  tags:
    - configure

- name: Create the initialization script
  copy:
    src: initialize.d/dokuwiki
    dest: /opt/common/initialize.d/21-dokuwiki.sh
    mode: 0755

- name: Subscribe to hooks
  copy:
    src: hooks/user
    dest: /opt/common/hooks/{{ item }}.d/dokuwiki
    mode: 0755
  with_items:
    - user-created
    - user-passwd
    - user-deleted
