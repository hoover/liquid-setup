#!/usr/bin/env python3

from pathlib import Path
import os
from subprocess import run, PIPE

def which_ansible_playbook():
    return run(['which', 'ansible-playbook'], stdout=PIPE).stdout.strip()

ansible_playbook = which_ansible_playbook()
if not ansible_playbook:
    print("ansible not found; installing...")
    run(['apt-add-repository', '-y', 'ppa:ansible/ansible'], check=True)
    run(['apt-get', '-qq', 'update'], check=True)
    run(['apt-get', '-qq', 'install', '-y', 'ansible', 'git', 'qemu-utils'],
        stdout=subprocess.DEVNULL, check=True)
    ansible_playbook = which_ansible_playbook()

assert ansible_playbook

setup = Path(__file__).resolve().parent.parent
(setup / 'ansible' / 'vars' / 'config.yml').touch()

os.chdir(str(setup / 'ansible'))
os.execv(ansible_playbook, [ansible_playbook, 'server.yml'])
